const express = require('express');
const mongoose = require('mongoose');
const fs = require('fs');
const path = require('path');
const cron = require('node-cron');
const nodemailer = require('nodemailer');
const { Client, LocalAuth } = require('whatsapp-web.js');
const qrcode = require('qrcode-terminal');

const app = express();

// --- 1. DIRECT SETTINGS (No .env needed for these) ---
const MONGO_URL = "mongodb+srv://tjjeyakumar007:jeyakumar2004@managementdb.dcqsomw.mongodb.net/managementDB?retryWrites=true&w=majority";
const EMAIL_USER = "jpfarming10@gmail.com";
const EMAIL_PASS = "mmrn lasr hnuv irpy";
const ADMIN_PHONES = ["9500591897", "9159659711"];

// --- 2. DATABASE CONNECTION ---
mongoose.connect(MONGO_URL)
    .then(() => console.log('âœ… MONGODB: CONNECTED SUCCESSFULLY!'))
    .catch(err => console.error('âŒ MONGODB ERROR:', err));

// --- 3. WHATSAPP INITIALIZATION ---
const client = new Client({
    authStrategy: new LocalAuth(),
    puppeteer: { headless: true, args: ['--no-sandbox'] }
});

client.on('qr', (qr) => qrcode.generate(qr, { small: true }));
client.on('ready', () => {
    console.log('âœ… WHATSAPP: READY & CONNECTED');
    global.client = client;
});
client.initialize();

// --- 4. EMAIL SETUP ---
const transporter = nodemailer.createTransport({
    service: 'gmail',
    auth: { user: EMAIL_USER, pass: EMAIL_PASS }
});

// --- 5. AUTOMATION SCHEDULER (TEST @ 09:15 AM) ---
const DESKTOP_PATH = path.join(process.env.USERPROFILE, 'Desktop', 'TJP_Reports.csv');

cron.schedule('15 09 * * *', async () => {
    console.log("ğŸš€ Starting Triple Backup...");
    const today = new Date().toLocaleDateString('en-IN');
    const reportMsg = `ğŸ“ *TJP DAILY REPORT*\nğŸ“… Date: ${today}\nğŸ’° Sales: â‚¹5400\nâœ… System Working.`;

    try {
        // A. WhatsApp
        if (global.client) {
            for (let num of ADMIN_PHONES) {
                await global.client.sendMessage(`${num}@c.us`, reportMsg);
            }
            console.log("âœ… WhatsApp Sent!");
        }

        // B. Local Excel
        const csvRow = `${today}, 5400\n`;
        if (!fs.existsSync(DESKTOP_PATH)) {
            fs.writeFileSync(DESKTOP_PATH, 'Date, Sales\n');
        }
        fs.appendFileSync(DESKTOP_PATH, csvRow);
        console.log("âœ… Desktop CSV Updated!");

        // C. Email
        await transporter.sendMail({
            from: EMAIL_USER,
            to: EMAIL_USER,
            subject: `TJP Backup - ${today}`,
            text: reportMsg
        });
        console.log("âœ… Email Sent!");

    } catch (err) {
        console.error("âŒ Backup Error:", err);
    }
});

app.listen(5000, () => console.log('ğŸ¤– TJP Server running on Port 5000'));